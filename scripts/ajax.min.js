function showNotice(e){if(e!=0){$("#savedOrder").find(".result").html("Successfully Saved");$("#savedOrder").find(".reference").html("Order no. is "+e)}else{$("#savedOrder").find(".result").html("Saved Locally");$("#savedOrder").find(".reference").html("")}$.mobile.changePage("#savedOrder",{transition:"slide",reverse:false,changeHash:true})}function onSuccess(e){if(e.Name!=undefined){Store.set("user",e,stayloggedin);app.initialize()}else{$.mobile.hidePageLoadingMsg();navigator.notification.alert("Incorrect Login",callBack,"Error");$("#txtUserName").val("");$("#txtPassword").val("")}}function login(e){e.preventDefault();var t=$("#txtUserName").val().trim();var n=$("#txtPassword").val().trim();if(t==""||n==""){navigator.notification.alert("Please Fill The Details Completely",callBackFunc,"Error");return false}$.mobile.loadingMessageTextVisible=true;$.mobile.loadingMessage="Login";$.mobile.loadingMessageTheme="c";$.mobile.showPageLoadingMsg();$.ajax({type:"POST",url:url+"do_login",data:{username:t,password:n},cache:true,dataType:"json",success:onSuccess,error:onerror});return false}function onerror(e){navigator.notification.alert("Error In Your Internet Connection",callBackFunc,"Error");$.mobile.hidePageLoadingMsg();$("#txtUserName").val("");$("#txtPassword").val("")}function callBackFunc(){}var categorySelected="Category";var app={initialize:function(){var e=this;if(!Store.isSet("appData."+Store.get("user").Userid)){this.getAppData(app.changePage)}else{this.changePage()}},fetch:function(e){$.getJSON(url+e,function(t){Store.set(e+"."+Store.get("user").Userid,t,0)})},getAppData:function(e){$.mobile.loadingMessage="Customers";$.mobile.showPageLoadingMsg();unBindEvents();var t=Store.get("user").Userid;$.getJSON(url+"customers",{userid:t},function(e){$.each(e,function(e,t){t.order=0});Store.set("customers."+Store.get("user").Userid,e,0)}).done(function(){$.mobile.loadingMessage="Products";$.mobile.showPageLoadingMsg();$.getJSON(url+"products",function(e){Store.set("products."+Store.get("user").Userid,e,0)}).done(function(){var t=Store.get("products."+Store.get("user").Userid);var n=getDistinct(t,"pmCategory");Store.set("category."+Store.get("user").Userid,n,0);$.mobile.loadingMessage="Loading..";bindEvents();$.mobile.showPageLoadingMsg();Store.set("appData."+Store.get("user").Userid,"1",0);e()})})},changePage:function(){$.mobile.changePage("#saleOrderSelectCustomer",{transition:"slide",reverse:false,changeHash:true});var e=Store.get("customers."+Store.get("user").Userid);app.loadPage(e);return false},loadPage:function(e){e=sortByKey(e,"order");var t;var n;var r;var i;$("#ui-results").children(".added").remove();$.each(e,function(e,s){if(e>=10){return false}n=s.smStoreName.split("-");r=s.smStoreName;i=s.smStoreName;if(typeof n[0]!="undefined"){r=$.trim(n[0])}if(typeof n[1]!="undefined"){i=$.trim(n[1])}t=$(".template",$("#ui-results")).clone().removeClass("template");$(".storeName",t).html(r);$(".storeCode",t).html(s.smStoreCode);$(".location",t).html(i);$(".storeId",t).val(s.smId);$(t).addClass("added");$(t).appendTo("#ui-results");$("#ui-results").show()});$(".customer").unbind("tap",orders.selectCustomer);$(".customer").bind("tap",{page:"#saleOrderEntry"},orders.selectCustomer);$.mobile.hidePageLoadingMsg();$("#txtUserName").val("");$("#txtPassword").val("");return false},postData:function(e,t,n){$.mobile.loadingMessageTextVisible=true;$.mobile.loadingMessage="Sending..";$.mobile.showPageLoadingMsg();unBindEvents();var r=[];if(Store.isSet(t+"."+Store.get("user").Userid)){r=Store.get(t+"."+Store.get("user").Userid);Store.clear(t+"."+Store.get("user").Userid)}$.ajax({type:"POST",url:url+t,data:e,cache:false,dataType:"html",success:function(i){e["savedStatus"]="true";e["referenceNo"]=i;e["serialNo"]=r.length+1;r.push(e);Store.set(t+"."+Store.get("user").Userid,r,0);n(i);bindEvents();$.mobile.hidePageLoadingMsg()},error:function(){r=sortByKey(r,"serialNo");e["referenceNo"]=0;e["savedStatus"]="false";var i=getObject(r,"date",e["date"]);if(i){e["serialNo"]=r[i]["serialNo"];r.splice(i,1)}else{if(typeof r[r.length-1]=="undefined")e["serialNo"]=r.length+1;else e["serialNo"]=r[r.length-1]["serialNo"]+1}r.push(e);Store.set(t+"."+Store.get("user").Userid,r,0);n(0);bindEvents();$.mobile.hidePageLoadingMsg()}})}};var orders={pendingOrders:[],products:[],savedOrders:[],viewOrder:function(e){e.preventDefault();editMode=false;var t=$(this).find("input.storeId").val();var n=$(this).find("input.serialNo").val();var r=$(this).find("span.storeName").html();var i=$(this).find("span.location").html();var s=$(this).find("span.storeCode").html();$("#saleOrderEntry").find(".storeId").val(t);$("#saleOrderEntry").find(".storeName").html(r);$("#saleOrderEntry").find(".location").html(i);$("#saleOrderEntry").find(".storeCode").html(s);var o=getObject(Store.get("order."+Store.get("user").Userid),"serialNo",n);orders.savedOrders=Store.get("order."+Store.get("user").Userid)[o];$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:true,changeHash:true});return false},selectCustomer:function(){editMode=true;var e=$(this).find("input.storeId").val();var t=$(this).find("strong.storeName").html();var n=$(this).find("span.location").html();var r=$(this).find("span.storeCode").html();var s={storeId:e,storeName:t,location:n,storeCode:r,items:[]};var o=getObject(orders.pendingOrders,"storeId",e);if(!o){orders.pendingOrders.push(s);o=orders.pendingOrders.length-1}for(i in orders.pendingOrders){orders.pendingOrders[i]["selectedOrder"]=false;if(i==o){orders.pendingOrders[i]["selectedOrder"]=true}}$("#saleOrderEntry").find(".storeId").val(e);$("#saleOrderEntry").find(".storeName").html(t);$("#saleOrderEntry").find(".location").html(n);$("#saleOrderEntry").find(".storeCode").html(r);$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:true,changeHash:true});return false},removeItem:function(e){e.preventDefault();var t=$(this).parent().find(".productId").val();var n=getObject(orders.pendingOrders,"selectedOrder",true);var r=getObject(orders.pendingOrders[n].items,"productId",t);orders.pendingOrders[n].items.splice(r,1);$("#editItem").popup("close");$.each($("#ui-items").find("li"),function(e){if($(this).find(".productId").val()==t){$(this).remove()}});return false},addProduct:function(e){e.preventDefault();if($(this).parent().find(".productId").val()!==""){var t;var n;var r;var i=$(this).parent().find(".productId").val();if(editMode){t=getObject(orders.pendingOrders,"selectedOrder",true);n=getObject(orders.pendingOrders[t].items,"productId",i);r=orders.pendingOrders[t].items[n]}else{n=getObject(orders.savedOrders.items,"productId",i);r=orders.savedOrders.items[n]}categorySelected=r.category;$("#enterProducts").find("#category").val(r.category).change();$("#enterProducts").find("#productId").val(r.productId);$("#enterProducts").find("#product").val(r.productName);$("#enterProducts").find("#quantity").val(r.quantity);$("#enterProducts").find("#offerquantity").val(r.offerquantity)}else{$("#enterProducts").find("#category").val(categorySelected).change();$("#enterProducts").find("#productId").val("");$("#enterProducts").find("#product").val("");$("#enterProducts").find("#quantity").val("");$("#enterProducts").find("#offerquantity").val("")}$.mobile.changePage("#enterProducts",{transition:"slide",reverse:false,changeHash:true});return false},validateItem:function(){if($("#category option:selected").text()=="Category"){throw"Invalid category";return false}if($.trim($("#product").val())==""){throw"Invalid product";return false}if($("#productId").val()==""&&$.trim($("#product").val())==""){throw"Product not selected";return false}if($.trim($("#quantity").val())==""||isNaN($.trim($("#quantity").val()))){$("#quantity").val("");throw"Invalid quantity";return false}if(isNaN($.trim($("#offerquantity").val()))){$("#offerquantity").val("");throw"Invalid offer quantity";return false}},addItem:function(){var e=getObject(orders.pendingOrders,"selectedOrder",true);var t=getObject(orders.pendingOrders[e].items,"productId",$("#productId").val());if(t){orders.pendingOrders[e].items.splice(t,1)}try{orders.validateItem();var n=getObjects(Store.get("products."+Store.get("user").Userid),"pmProductId",$("#productId").val(),"exact");var r={productId:$("#productId").val(),productName:$("#product").val(),category:$("#category option:selected").text(),quantity:$("#quantity").val(),offerquantity:$("#offerquantity").val(),unitprice:n[0]["pmMRP"]};orders.pendingOrders[e].items.push(r);$("#productId").val("");$("#product").val("");$("#quantity").val("");$("#offerquantity").val("")}catch(i){navigator.notification.alert(i,callBackFunc,"Error");throw i}return false},finish:function(e){e.preventDefault();if($.trim($("#product").val())==""&&($.trim($("#quantity").val())==""||$.trim($("#offerquantity").val())=="")){$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:false,changeHash:true})}else{try{orders.addItem();$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:false,changeHash:true})}catch(t){return false}}return false},saveOrder:function(e){e.preventDefault();var t=getObject(orders.pendingOrders,"selectedOrder",true);if(orders.pendingOrders[t].items.length==0){navigator.notification.alert("No item to save",callBackFunc,"Error");return false}var n=orders.pendingOrders[t];n["date"]=Date.now();delete n["selectedOrder"];app.postData(n,"order",showNotice);orders.pendingOrders.splice(t,1);return false},selectCategory:function(e){e.preventDefault();$("#product").val("");$("#ui-results-products").children(".added").remove();categorySelected=$(this).find("option:selected").text();orders.products=getObjects(Store.get("products."+Store.get("user").Userid),"pmCategory",categorySelected,"exact");$("#product").focus();return false},searchProduct:function(e){e.preventDefault();if($("#category option:selected").text()=="Category"){navigator.notification.alert("Select Category first",callBackFunc,"Error");return false}if($.trim($(this).val()).length==0){return false}var t=getObjects(orders.products,"pmProductName",$.trim($(this).val()));var n;$("#ui-results-products").children(".added").remove();$.each(t,function(e,t){if(e>=10){return false}n=$(".template:first",$("#ui-results-products")).clone().removeClass("template");$(".productName",n).html(t.pmProductName);$(".productCode",n).html(t.pmProductCode);$(".productId",n).val(t.pmProductId);$(n).addClass("added");$(n).appendTo("#ui-results-products")});$(".products").unbind("tap",orders.selectProduct).bind("tap",orders.selectProduct);return false},selectProduct:function(){var e=$(this).find("input.productId").val();var t=$(this).find("strong.productName").html();$("#product").val(t);$("#productId").val(e);$("#ui-results-products").children(".added").remove();$("#quantity").focus();return false}}
